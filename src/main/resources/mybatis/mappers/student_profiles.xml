<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.a2m.profileservice.mapper.StudentProfilesMapper">

    <!-- Map kết quả từ cơ sở dữ liệu thành User -->
    <resultMap id="studentProfileResultMap" type="com.a2m.profileservice.model.student_profiles">
        <id property="profileId" column="profile_id" />
        <result property="fullName" column="full_name" />
        <result property="major" column="major" />
        <result property="dateOfBirth" column="date_of_birth" jdbcType="DATE"/>
        <result property="address" column="address" />
        <result property="university" column="university" />
        <result property="avatarUrl" column="avatar_url" />
        <result property="academicYearStart" column="academic_year_start" jdbcType="DATE"/>
        <result property="academicYearEnd" column="academic_year_end" jdbcType="DATE"/>
        <result property="phoneNumber" column="phone_number" />
        <result property="isApproved" column="is_approved" jdbcType="BOOLEAN"/>
        <result property="status" column="status" />
        <result property="isDeleted" column="is_deleted" jdbcType="BOOLEAN"/>
        <result property="createdAt" column="created_at" jdbcType="TIMESTAMP"/>
        <result property="updatedAt" column="updated_at" jdbcType="TIMESTAMP"/>
    </resultMap>


    <!-- Lấy thông tin User theo ID -->
    <select id="getAll" resultMap="studentProfileResultMap">
        SELECT * FROM profile_service.student_profiles
    </select>

    <select id="getById" resultMap="studentProfileResultMap">
        SELECT * FROM profile_service.student_profiles where profile_id = #{id}
    </select>

    <select id="checkExits" resultType="int">
        SELECT COUNT(1)
        FROM profile_service.student_profiles
        WHERE profile_id = #{id}
    </select>


    <insert id="createStudentProfile" parameterType="student_profiles">
        INSERT INTO profile_service.student_profiles (
        profile_id, full_name, major, date_of_birth, address, university
        , academic_year_start, academic_year_end, phone_number,
        is_approved, status, is_deleted, created_at, updated_at
        )
        VALUES (
        #{profileId}, #{fullName}, #{major}, #{dateOfBirth}, #{address},
        #{university}, #{academicYearStart}, #{academicYearEnd},
        #{phoneNumber}, 0, 1,
        0, <!-- isDeleted = 0 -->
        NOW(), <!-- createdAt = current time -->
        NOW() <!-- updatedAt = NULL -->
        )
    </insert>

    <update id="updateStudentProfile" parameterType="student_profiles">
        UPDATE student_profiles
        SET
        full_name = #{fullName},
        major = #{major},
        date_of_birth = #{dateOfBirth},
        address = #{address},
        university = #{university},
        avatar_url = #{avatarUrl},
        academic_year_start = #{academicYearStart},
        academic_year_end = #{academicYearEnd},
        phone_number = #{phoneNumber},
        updated_at = NOW()  <!-- Cập nhật trường updated_at thành thời gian hiện tại -->
        WHERE profile_id = #{profileId}
    </update>


    <update id="UpdateAvatar">
        UPDATE student_profiles
        SET avatar_url = #{avatar},
            updated_at = NOW()
        WHERE profile_id = #{id}
    </update>

    <select id="getStudentName" parameterType="String" resultType="string">
        SELECT full_name
        FROM profile_service.student_profiles
        WHERE profile_id = #{profileId}
          AND is_deleted = false
    </select>

</mapper>