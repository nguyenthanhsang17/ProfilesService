<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.a2m.profileservice.mapper.RequestStudentMapper">

    <!-- Map kết quả từ cơ sở dữ liệu thành User -->
    <resultMap id="requestStudentsResultMap" type="RequestStudents">
        <id property="requestId" column="request_id"/>
        <result property="studentId" column="student_id"/>
        <result property="reason" column="reason"/>
        <result property="sendTime" column="send_time" javaType="java.util.Date" jdbcType="TIMESTAMP"/>
        <result property="status" column="status"/>
        <result property="isDeleted" column="is_deleted" javaType="boolean" jdbcType="TINYINT"/>
    </resultMap>

    <select id="checkRequestStudentExists" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM request_students
        WHERE student_id = #{student_id}
          AND status = 'pending'
          AND is_deleted = 0
    </select>

    <select id="checkRequestStudentAlreadyRegistered" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM request_students
        WHERE student_id = #{student_id}
          AND status = 'pending' OR status = 'approve'
          AND is_deleted = 0
    </select>



    <insert id="SendRequest">
        INSERT INTO request_students
            (request_id, student_id, reason, send_time, status, is_deleted)
        VALUES
            (uuid(), #{student_id},null, NOW(), 'pending', 0)
    </insert>

    <select id="GetRequestStudent" parameterType="string" resultType="RequestStudents" resultMap="requestStudentsResultMap">
        SELECT
            request_id,
            student_id,
            reason,
            send_time,
            status,
            is_deleted
        FROM
            request_students
        WHERE
            student_id = #{student_id}
          AND is_deleted = 0
        ORDER BY
            send_time DESC
            LIMIT 1
    </select>

    <select id="getAllRequestStudents" resultMap="requestStudentsResultMap">
        SELECT * FROM request_students
        WHERE is_deleted = 0
        ORDER BY send_time DESC
    </select>


    <!-- Lấy request sinh viên theo status -->
    <select id="getRequestStudentByStatus" parameterType="string" resultMap="requestStudentsResultMap">
        SELECT * FROM request_students
        WHERE is_deleted = 0 AND status = #{status}
        ORDER BY send_time DESC
    </select>

    <select id="checkApproved" resultType="boolean" parameterType="string">
        SELECT COUNT(1) > 0
        FROM request_students
        WHERE student_id = #{id} AND status = 'approve'
    </select>




    <select id="getRequestStudentById" parameterType="string" resultMap="requestStudentsResultMap">
        SELECT * FROM request_students
        WHERE request_id = #{requestId}
          AND is_deleted = 0
    </select>

    <update id="updateRequestStudentStatus">
        UPDATE request_students
        SET status = #{status}
        WHERE request_id = #{requestId}
          AND is_deleted = 0
    </update>

    <update id="updateRejectReason">
        UPDATE request_students
        SET reason = #{reason}
        WHERE request_id = #{requestId}
    </update>
    <!-- get all request dung cursor pagination-->
    <select id="getRequestStudentsByCursor" parameterType="map" resultMap="requestStudentsResultMap">
        SELECT *
        FROM request_students
        WHERE is_deleted = 0
        <if test="status != null">
            AND status = #{status}
        </if>
        <if test="cursor != null">
            AND send_time &lt; #{cursor}
        </if>
        ORDER BY send_time DESC
        LIMIT #{limit}
    </select>

</mapper>